<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ellie’s Christmas Escape Padlock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html,body { margin:0; padding:0; height:100%; overflow:hidden; }

    body {
      min-height:100dvh;
      background: radial-gradient(circle at top, #081326 0, #030713 55%, #000 100%);
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:#fff;
      position:relative;
      display:flex;
      justify-content:center;
      align-items:center;
      padding: env(safe-area-inset-top,12px) 0 env(safe-area-inset-bottom,12px);
    }

    /* SNOW LAYERS */
    .snow-layer {
      position:fixed;
      inset:0;
      pointer-events:none;
      background-repeat:repeat;
      z-index:1;
      mix-blend-mode:screen;
    }

    .snow-back {
      background-size:360px 360px;
      animation:snowSlow 40s linear infinite;
      z-index:1;
      filter:blur(0.3px) contrast(1.05);
      opacity:0.95;
      background-image:
        radial-gradient(6px 6px at 30px 40px, rgba(230,240,255,0.45), transparent 40%),
        radial-gradient(5px 5px at 170px 80px, rgba(255,230,245,0.5), transparent 40%),
        radial-gradient(4px 4px at 260px 30px, rgba(210,240,255,0.4), transparent 40%),
        radial-gradient(6px 6px at 220px 170px, rgba(255,255,255,0.44), transparent 40%),
        radial-gradient(5px 5px at 60px 260px, rgba(220,255,230,0.42), transparent 40%),
        radial-gradient(8px 8px at 300px 300px, rgba(255,255,255,0.32), transparent 40%);
    }
    @keyframes snowSlow { 0%{transform:translateY(-90px)}100%{transform:translateY(90px)} }

    .snow-mid {
      background-size:260px 260px;
      animation:snowMid 22s linear infinite;
      z-index:2;
      filter:blur(0.45px) contrast(1.08);
      opacity:0.98;
      background-image:
        radial-gradient(8px 8px at 20px 20px, rgba(230,244,255,0.78), transparent 40%),
        radial-gradient(7px 7px at 140px 50px, rgba(255,235,245,0.7), transparent 40%),
        radial-gradient(6px 6px at 70px 200px, rgba(235,255,240,0.7), transparent 40%),
        radial-gradient(8px 8px at 240px 10px, rgba(250,252,255,0.8), transparent 40%),
        radial-gradient(5px 5px at 180px 240px, rgba(230,250,255,0.7), transparent 40%);
    }
    @keyframes snowMid { 0%{transform:translate(-12px,-100px)}100%{transform:translate(12px,100px)} }

    .snow-front {
      background-size:140px 140px;
      animation:snowFast 14s linear infinite;
      z-index:9;
      filter:blur(0.7px) contrast(1.12) saturate(1.05);
      opacity:1;
      background-image:
        radial-gradient(10px 10px at 20px 20px, rgba(255,255,255,0.98), transparent 45%),
        radial-gradient(8px 8px at 100px 40px, rgba(210,235,255,0.97), transparent 45%),
        radial-gradient(10px 10px at 220px 120px, rgba(255,235,245,0.98), transparent 45%),
        radial-gradient(8px 8px at 60px 200px, rgba(220,255,235,0.97), transparent 45%),
        radial-gradient(10px 10px at 260px 10px, rgba(255,255,255,0.98), transparent 45%),
        radial-gradient(8px 8px at 150px 260px, rgba(215,240,255,0.96), transparent 45%),
        radial-gradient(14px 14px at 50px 120px, rgba(255,230,210,0.9), transparent 45%),
        radial-gradient(12px 12px at 180px 40px, rgba(230,255,230,0.9), transparent 45%);
    }
    @keyframes snowFast { 0%{transform:translate(28px,-120px)}100%{transform:translate(-28px,120px)} }

    /* SANTA (background) */
    .santa {
      position: fixed;
      top: 10%;
      left: -40%;
      width: 260px;
      height: auto;
      z-index: 0; /* behind snow layers */
      pointer-events: none;
      opacity: 0;
      transform-origin: center;
      will-change: left, transform, top, opacity;
    }
    .santa.fly-running { transition-property: left, opacity, transform; transition-timing-function: linear, linear, ease; }

    /* BOTTOM PILE (GROUND – stays horizontal) */
    .snow-pile {
      position: fixed;
      bottom:0;
      left:0;
      right:0;
      height:0;
      max-height:220px;
      z-index:3;
      pointer-events:none;
      display:flex;
      justify-content:center;
      overflow:visible;
      transition:height 420ms ease-out;
    }
    .snow-pile-inner {
      position:absolute; left:0; right:0; bottom:0; height:100%;
      background:
        radial-gradient(ellipse at bottom, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.9) 30%, rgba(230,244,255,0.2) 65%, transparent 100%),
        radial-gradient(circle at 12% 10%, rgba(255,232,210,0.9), transparent 60%),
        radial-gradient(circle at 88% 12%, rgba(214,237,255,0.88), transparent 60%);
      filter: blur(0.6px) contrast(1.05);
      box-shadow: inset 0 8px 28px rgba(255,255,255,0.08), 0 -2px 10px rgba(0,0,0,0.35);
      border-top-left-radius:60% 40%;
      border-top-right-radius:60% 40%;
      pointer-events:none;
      width:100%;
      transform-origin:50% 100%;
    }
    .snow-pile-sheen {
      position:absolute;
      left:10%;
      right:10%;
      bottom:calc(100% - 10px);
      height:24px;
      background:linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.12));
      filter:blur(8px);
      opacity:0.6;
      border-radius:50%;
      pointer-events:none;
      transform-origin:50% 100%;
    }

    /* TOP PILE OVER LOCK */
    .snow-pile-top {
      position:absolute;
      left:-12px;
      width:calc(100% + 24px);
      top:-18px;
      height:0;
      z-index:5;
      pointer-events:none;
      /* hide the top pile fully when height is zero so it doesn't cover the lock on small screens */
      overflow:hidden;
      transition:height 420ms ease-out, opacity 280ms ease, transform 280ms ease;
      opacity:0;
      transform-origin:50% 100%;
    }
    .snow-pile-top.show { opacity:1; }
    .snow-pile-top svg { width:100%; height:100%; display:block; overflow:visible; }
    .snow-pile-top-inner { pointer-events:none; }

    /* PADLOCK & UI */
    .app-shell { position:relative; width:100%; max-width:420px; margin:0 auto; padding:0 16px 24px; z-index:6; }
    .padlock { position:relative; margin:0 auto; max-width:300px; padding-top:50px; animation:fadeIn .7s ease-out both; z-index:6; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(30px) scale(.9)} to{opacity:1; transform:translateY(0) scale(1)} }
    .padlock.open { transform:translateY(-4px) scale(1.02); }

    .shackle {
      position:absolute;
      top:-70px;
      left:50%;
      width:140px;
      height:120px;
      border-radius:80px 80px 0 0;
      border:10px solid #d6dde2;
      border-bottom:none;
      background:transparent;
      transform:translateX(-50%);
      z-index:7;
      box-shadow:0 8px 14px rgba(0,0,0,0.45);
      transition:transform .6s ease;
      transform-origin:20% 20%;
    }
    /* Removed the dark semicircle by clearing the inner background and inner shadow */
    .shackle::before {
      content:"";
      position:absolute;
      top:16px;
      left:50%;
      width:104px;
      height:92px;
      border-radius:60px 60px 0 0;
      transform:translateX(-50%);
      background: transparent;
      box-shadow: none;
    }
    .shackle::after {
      content:"";
      position:absolute;
      bottom:-4px;
      left:50%;
      width:40px;
      height:22px;
      transform:translateX(-50%);
      background:linear-gradient(180deg,#f9de9c,#c18a2d 70%,#8e5d13 100%);
      border-radius:0 0 12px 12px;
      box-shadow:0 2px 4px rgba(0,0,0,0.6), inset 0 0 4px rgba(255,255,255,0.5);
    }

    .padlock.open .shackle { transform:translate(-10px,-10px) rotate(-25deg); }

    .lock-body {
      background: linear-gradient(180deg,#fbeab7,#d6a850 60%,#a36b1e 100%);
      padding:18px 14px 22px;
      border-radius:20px;
      box-shadow:
        0 16px 28px rgba(0,0,0,0.85),
        0 0 20px rgba(255,210,130,0.5),
        inset 0 0 16px rgba(0,0,0,0.4);
      border:1px solid rgba(255,245,220,0.9);
      position:relative;
      z-index:4;
      overflow:visible;
    }

    /* FAIRY LIGHTS */
    .fairy-lights {
      position:absolute;
      top:8px;
      left:16px;
      right:16px;
      height:18px;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 5% 60%, rgba(255,180,130,1), transparent 60%),
        radial-gradient(circle at 20% 40%, rgba(255,90,120,0.95), transparent 60%),
        radial-gradient(circle at 40% 55%, rgba(120,220,255,0.95), transparent 60%),
        radial-gradient(circle at 60% 45%, rgba(140,255,190,0.95), transparent 60%),
        radial-gradient(circle at 80% 60%, rgba(255,220,130,0.98), transparent 60%),
        radial-gradient(circle at 95% 40%, rgba(200,190,255,0.98), transparent 60%);
      filter:blur(0.4px);
      mix-blend-mode:screen;
      opacity:0.9;
      animation:twinkle 2.8s ease-in-out infinite alternate;
    }
    @keyframes twinkle {
      0% { opacity:0.4; transform:translateY(0); }
      50%{ opacity:0.9; transform:translateY(-0.5px); }
      100%{ opacity:0.6; transform:translateY(0); }
    }

    .title { text-align:center; font-size:15px; letter-spacing:0.22em; text-transform:uppercase; color:#351f0a; margin-bottom:3px; }
    .subtitle { text-align:center; font-size:12px; letter-spacing:0.25em; text-transform:uppercase; color:#5a310f; margin-bottom:14px; }
    .dial-plate {
      background: radial-gradient(circle at top,#28422c,#111b13 60%,#050806 100%);
      padding:14px 10px 16px;
      border-radius:14px;
      box-shadow:inset 0 0 18px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.12);
    }
    .dials { display:flex; justify-content:center; gap:8px; margin-bottom:12px; flex-wrap:nowrap; }
    .dial {
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:6px 5px;
      width:46px;
      background:linear-gradient(180deg,#232323,#050505);
      border-radius:10px;
      box-shadow:inset 0 0 8px rgba(0,0,0,0.9), 0 4px 7px rgba(0,0,0,0.7);
      border:1px solid rgba(255,255,255,0.06);
      cursor:grab;
    }
    .dial.dragging { cursor:grabbing; }
    .dial button {
      border:none;
      background:linear-gradient(180deg,#33b46b,#13763f);
      color:#f6fff6;
      border-radius:6px;
      padding:6px 0;
      width:100%;
      font-size:18px;
      box-shadow:0 2px 3px rgba(0,0,0,0.7);
      min-height:34px;
    }
    .display {
      margin:6px 0;
      padding:7px 0;
      width:100%;
      text-align:center;
      background:#000;
      color:#00f7ff;
      font-size:26px;
      border-radius:6px;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.9);
      touch-action:none;
    }
    .hint { text-align:center; font-size:12px; color:#ffe9c0; opacity:0.9; margin-top:4px; }

    .tilt-btn {
      margin:10px auto 0;
      padding:6px 12px;
      font-size:12px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.45);
      color:#fff;
      cursor:pointer;
      display:block;
    }
    .tilt-btn.active { background: rgba(12,103,34,0.8); border-color: rgba(180,255,200,0.8); }

    .message {
      text-align:center;
      margin-top:12px;
      font-size:15px;
      line-height:1.4;
      opacity:0;
      color:#fff;
      background: rgba(0,0,0,0.78);
      border-radius:10px;
      padding:8px 10px;
      text-shadow:0 0 6px rgba(0,0,0,0.8);
      border:1px solid rgba(255,255,255,0.12);
      transform:translateY(8px);
      transition:opacity .4s ease, transform .4s ease;
    }
    .message span { display:block; font-size:13px; margin-top:3px; color:#e6ffe3; }
    .padlock.open .message { opacity:1; transform:translateY(0); }

    .keyhole {
      margin:12px auto 0;
      width:18px;
      height:26px;
      border-radius:12px;
      background: radial-gradient(circle at 50% 20%, #222,#000);
      box-shadow: inset 0 0 4px rgba(255,255,255,0.1);
    }

    /* reduced-motion */
    @media (prefers-reduced-motion: reduce) {
      .snow-layer, .snow-pile, .padlock, .santa { animation:none !important; }
      .snow-back, .snow-mid, .snow-front { background-position:center !important; }
      .snow-pile-inner, .snow-pile-top-inner { transition:none !important; }
      .santa { display:none; }
    }

    @media (max-width:400px) {
      .padlock { max-width:260px; padding-top:45px; }
      .dial { width:40px; }
      .title { font-size:13px; letter-spacing:0.18em; }
      .subtitle { font-size:11px; letter-spacing:0.2em; }
      .message { font-size:14px; }
      .santa { width:180px; left:-40%; top:8%; }
    }
  </style>
</head>
<body>
  <!-- SANTA -->
  <div class="santa" id="santa" aria-hidden="true">
    <!-- Improved sleigh + reindeer SVG for a more realistic look -->
    <svg viewBox="0 0 300 90" width="100%" height="100%" preserveAspectRatio="xMinYMid meet" aria-hidden="true" role="img" focusable="false">
      <defs>
        <!-- Wood gradient -->
        <linearGradient id="wood" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0" stop-color="#8b4a2b"/>
          <stop offset="0.5" stop-color="#6b331b"/>
          <stop offset="1" stop-color="#4a1f12"/>
        </linearGradient>
        <linearGradient id="wood-highlight" x1="0" x2="1">
          <stop offset="0" stop-color="rgba(255,230,200,0.35)"/>
          <stop offset="1" stop-color="rgba(255,230,200,0)"/>
        </linearGradient>
        <!-- Metal runner gradient -->
        <linearGradient id="metal" x1="0" x2="1">
          <stop offset="0" stop-color="#d7d9db"/>
          <stop offset="0.5" stop-color="#bfc3c6"/>
          <stop offset="1" stop-color="#9aa0a4"/>
        </linearGradient>
        <!-- Seat fabric -->
        <linearGradient id="seat" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0" stop-color="#b22a2a"/>
          <stop offset="1" stop-color="#7a1b1b"/>
        </linearGradient>
        <!-- Reindeer fill -->
        <linearGradient id="deerFill" x1="0" x2="1">
          <stop offset="0" stop-color="#e5c6a0"/>
          <stop offset="1" stop-color="#b78a60"/>
        </linearGradient>
        <!-- Shadow filter -->
        <filter id="softShadow" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.35"/>
        </filter>
      </defs>

      <g transform="translate(0,6)" stroke="none">
        <!-- Sleigh body -->
        <g transform="translate(18,18)">
          <!-- main wooden shell -->
          <path d="M0 24 C12 2 65 0 98 0 C125 0 190 6 220 24 C200 36 90 56 30 54 C10 54 0 40 0 24 Z"
                fill="url(#wood)" />
          <!-- wood grain/highlight -->
          <path d="M6 26 C40 10 120 8 170 24 C135 34 70 46 34 44 C16 44 8 36 6 26 Z"
                fill="url(#wood-highlight)" opacity="0.65"/>
          <!-- decorative trim -->
          <path d="M0 28 L6 28 C40 16 120 14 170 28 L216 28" stroke="#ffd8a6" stroke-width="2.2" fill="none" opacity="0.9"/>
          <!-- seat cushion -->
          <rect x="110" y="0" width="36" height="20" rx="4" fill="url(#seat)" stroke="#3b0f0f" stroke-width="0.8"/>
          <!-- cushion top stitch -->
          <path d="M112 6 C126 2 134 2 144 6" stroke="rgba(255,255,255,0.12)" stroke-width="1.6" fill="none" opacity="0.9"/>
          <!-- padded back -->
          <rect x="106" y="-6" width="44" height="8" rx="3" fill="#5b1212" opacity="0.9"/>
        </g>

        <!-- Runners and metal details -->
        <g transform="translate(8,66)">
          <path d="M8 0 C28 -4 110 -4 164 0" stroke="url(#metal)" stroke-width="6" stroke-linecap="round" fill="none" filter="url(#softShadow)"/>
          <path d="M12 6 C32 2 112 2 160 6" stroke="#2a2a2a" stroke-width="1" stroke-linecap="round" opacity="0.25" fill="none"/>
          <path d="M0 0 C20 -6 132 -6 188 0" stroke="url(#metal)" stroke-width="3" stroke-linecap="round" opacity="0.6"/>
        </g>

        <!-- Driver (simple but with scarf) -->
        <g transform="translate(140,14)">
          <!-- head -->
          <circle cx="0" cy="6" r="6" fill="#ffd9bd" />
          <!-- hat -->
          <path d="M-7 -2 Q0 -10 8 -2" fill="#c21b2b" />
          <circle cx="6" cy="-3" r="2" fill="#fff"/>
          <!-- scarf -->
          <path d="M-6 12 C-4 14 2 14 6 12 L6 14 C2 16 -4 16 -6 14 Z" fill="#d84b3f"/>
        </g>

        <!-- Reindeer silhouettes with harness -->
        <g transform="translate(208,-6) scale(0.9)">
          <!-- Reindeer 1 -->
          <g transform="translate(0,18)">
            <path d="M0 6 L6 0 L12 2 L16 8 L20 6 L24 10 L18 14 L14 22 L6 20 Z" fill="url(#deerFill)" />
            <path d="M-6 4 L-2 -4 L2 -2 L6 4" fill="url(#deerFill)" opacity="0.95"/>
            <!-- antlers -->
            <path d="M2 -2 L6 -6 M4 -2 L8 -8 M0 -2 L-4 -6" stroke="#6a4530" stroke-width="0.9" stroke-linecap="round" fill="none"/>
            <!-- nose -->
            <circle cx="18" cy="8" r="1.4" fill="#c43a2a" />
            <!-- harness -->
            <path d="M10 6 C18 8 30 6 44 8" stroke="#703300" stroke-width="1" fill="none" stroke-linecap="round"/>
          </g>

          <!-- Reindeer 2 -->
          <g transform="translate(34,12) scale(0.95)">
            <path d="M0 8 L6 2 L12 4 L16 10 L20 8 L24 12 L18 16 L14 24 L6 22 Z" fill="url(#deerFill)" />
            <path d="M-6 6 L-2 -2 L2 0 L6 6" fill="url(#deerFill)" opacity="0.93"/>
            <path d="M2 0 L6 -6 M4 0 L8 -8" stroke="#6a4530" stroke-width="0.85" stroke-linecap="round" fill="none"/>
            <circle cx="18" cy="10" r="1.4" fill="#c43a2a" />
            <path d="M10 8 C20 10 36 8 52 10" stroke="#703300" stroke-width="1" fill="none" stroke-linecap="round"/>
          </g>

          <!-- Reindeer 3 -->
          <g transform="translate(68,18) scale(0.88)">
            <path d="M0 6 L6 0 L12 2 L16 8 L20 6 L24 10 L18 14 L14 22 L6 20 Z" fill="url(#deerFill)" />
            <path d="M-6 4 L-2 -4 L2 -2 L6 4" fill="url(#deerFill)" opacity="0.92"/>
            <path d="M2 -2 L6 -6 M4 -2 L8 -8" stroke="#6a4530" stroke-width="0.85" stroke-linecap="round" fill="none"/>
            <circle cx="18" cy="8" r="1.4" fill="#c43a2a" />
            <path d="M10 6 C22 8 40 6 60 8" stroke="#703300" stroke-width="1" fill="none" stroke-linecap="round"/>
          </g>
        </g>

        <!-- Reins + Bells -->
        <g transform="translate(150,34)" stroke="#6a2f13" stroke-width="0.9" stroke-linecap="round" fill="none">
          <path d="M0 0 C18 6 70 6 96 8" />
          <path d="M4 0 C22 8 84 10 106 14" opacity="0.7" />
          <!-- small bells along rein -->
          <circle cx="28" cy="6" r="1.2" fill="#ffd166" stroke="#b07a00" stroke-width="0.3"/>
          <circle cx="58" cy="7" r="1.2" fill="#ffd166" stroke="#b07a00" stroke-width="0.3"/>
          <circle cx="86" cy="8" r="1.2" fill="#ffd166" stroke="#b07a00" stroke-width="0.3"/>
        </g>

        <!-- small sparkle to add motion -->
        <g transform="translate(90,36)">
          <circle cx="0" cy="0" r="2.2" fill="#ffffff" opacity="0.95"/>
        </g>
      </g>
    </svg>
  </div>

  <!-- SNOW LAYERS -->
  <div class="snow-layer snow-back"></div>
  <div class="snow-layer snow-mid"></div>
  <div class="snow-layer snow-front"></div>

  <!-- BOTTOM PILE -->
  <div class="snow-pile" id="snowPile">
    <div class="snow-pile-inner" id="snowPileInner"></div>
    <div class="snow-pile-sheen" aria-hidden="true"></div>
  </div>

  <audio id="unlockSound" src="unlock.mp3"></audio>

  <div class="app-shell">
    <div class="padlock" id="padlock">
      <div class="shackle"></div>

      <div class="lock-body">
        <div class="fairy-lights" aria-hidden="true"></div>

        <!-- TOP PILE over lock -->
        <div class="snow-pile-top" id="snowPileTop" aria-hidden="true">
          <svg viewBox="0 0 300 80" preserveAspectRatio="none" aria-hidden="true">
            <defs>
              <filter id="blurEdge" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="3"></feGaussianBlur>
              </filter>

              <clipPath id="lockClipPath">
                <rect x="0" y="0" width="300" height="80" rx="18" ry="18"></rect>
              </clipPath>

              <mask id="lockMaskSvg" maskUnits="userSpaceOnUse" maskContentUnits="userSpaceOnUse">
                <rect x="0" y="0" width="300" height="80" rx="18" ry="18" fill="white" filter="url(#blurEdge)"></rect>
                <ellipse cx="150" cy="18" rx="80" ry="10" fill="white" fill-opacity="0.96"></ellipse>
              </mask>
            </defs>

            <g clip-path="url(#lockClipPath)">
              <rect x="0" y="0" width="300" height="80" fill="none" />
              <g mask="url(#lockMaskSvg)">
                <rect x="0" y="0" width="300" height="80" fill="none" />
                <ellipse cx="150" cy="34" rx="150" ry="60" fill="#ffffff" fill-opacity="0.95" />
                <ellipse cx="60" cy="30" rx="48" ry="28" fill="#f4f7ff" fill-opacity="0.96" />
                <ellipse cx="200" cy="28" rx="56" ry="24" fill="#fff1e3" fill-opacity="0.95" />
                <ellipse cx="150" cy="18" rx="100" ry="12" fill="#ffffff" fill-opacity="0.9" />
                <g fill-opacity="0.16">
                  <circle cx="40" cy="26" r="2.2" fill="#d6ecff"></circle>
                  <circle cx="80" cy="34" r="1.8" fill="#ffe0f1"></circle>
                  <circle cx="120" cy="28" r="1.6" fill="#e0ffe8"></circle>
                  <circle cx="170" cy="30" r="2.6" fill="#ffffff"></circle>
                  <circle cx="220" cy="26" r="1.6" fill="#e3f2ff"></circle>
                </g>
              </g>

              <rect x="0" y="54" width="300" height="26" fill="rgba(0,0,0,0.18)" opacity="0.5" />
            </g>
          </svg>
        </div>

        <div class="title">Ellie Snow Dome Escape</div>
        <div class="subtitle">CHRISTMAS EDITION</div>

        <div class="dial-plate">
          <div class="dials" id="dials"></div>

          <div class="hint">
            Ellie, drag or tap the dials to find the secret 6-letter word.<br>
            <span>When you crack it, your Christmas surprise will unlock…</span>
          </div>

          <button class="tilt-btn" id="tiltButton" type="button">Enable tilt snow</button>

          <div class="message" id="message"></div>
          <div class="keyhole"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CODE = "GLOVES";
    const SUCCESS_MESSAGE_MAIN = "Unlocked, Ellie! Merry Christmas!";
    const SUCCESS_MESSAGE_SUB = "You found the key – check inside the gloves.";

    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const dialsContainer = document.getElementById("dials");
    const padlockEl = document.getElementById("padlock");
    const messageEl = document.getElementById("message");
    const unlockSound = document.getElementById("unlockSound");

    const snowBack = document.querySelector(".snow-back");
    const snowMid = document.querySelector(".snow-mid");
    const snowFront = document.querySelector(".snow-front");
    const tiltButton = document.getElementById("tiltButton");
    const santaEl = document.getElementById("santa");

    const snowPileEl = document.getElementById("snowPile");
    const snowPileInner = document.getElementById("snowPileInner");
    const snowPileTopEl = document.getElementById("snowPileTop");

    const dialControllers = [];
    let globalDragging = false;

    document.addEventListener("touchmove", (e) => {
      if (globalDragging) e.preventDefault();
    }, { passive: false });

    function createDial(initialLetter = "A") {
      const dial = document.createElement("div");
      dial.className = "dial";

      const upBtn = document.createElement("button");
      upBtn.textContent = "▲";

      const display = document.createElement("div");
      display.className = "display";
      display.textContent = initialLetter;

      const downBtn = document.createElement("button");
      downBtn.textContent = "▼";

      dial.appendChild(upBtn);
      dial.appendChild(display);
      dial.appendChild(downBtn);

      let index = letters.indexOf(initialLetter);
      if (index === -1) index = 0;

      function updateDisplay() {
        display.textContent = letters[index];
        checkCode();
      }

      upBtn.onclick = () => {
        index = (index + 1) % letters.length;
        updateDisplay();
      };
      downBtn.onclick = () => {
        index = (index - 1 + letters.length) % letters.length;
        updateDisplay();
      };

      const STEP = 26;
      let dragging = false, lastY = 0, accum = 0;

      function start(y) {
        dragging = true;
        globalDragging = true;
        lastY = y;
        accum = 0;
        dial.classList.add("dragging");
      }

      function move(y) {
        const dy = y - lastY;
        accum += dy;
        lastY = y;

        while (accum <= -STEP) {
          index = (index + 1) % letters.length;
          accum += STEP;
          updateDisplay();
        }
        while (accum >= STEP) {
          index = (index - 1 + letters.length) % letters.length;
          accum -= STEP;
          updateDisplay();
        }
      }

      function end() {
        dragging = false;
        globalDragging = false;
        dial.classList.remove("dragging");
      }

      display.addEventListener("pointerdown", (e) => {
        display.setPointerCapture(e.pointerId);
        start(e.clientY);
      });
      display.addEventListener("pointermove", (e) => {
        if (dragging) move(e.clientY);
      });
      display.addEventListener("pointerup", end);
      display.addEventListener("pointercancel", end);

      return { element: dial, getLetter: () => letters[index] };
    }

    function setupDials() {
      for (let i = 0; i < CODE.length; i++) {
        const c = createDial("A");
        dialControllers.push(c);
        dialsContainer.appendChild(c.element);
      }
    }

    function checkCode() {
      const attempt = dialControllers.map((c) => c.getLetter()).join("");
      if (attempt === CODE && !padlockEl.classList.contains("open")) {
        padlockEl.classList.add("open");
        messageEl.innerHTML = SUCCESS_MESSAGE_MAIN + "<br><span>" + SUCCESS_MESSAGE_SUB + "</span>";
        unlockSound.currentTime = 0;
        unlockSound.play().catch(() => {});
      }
    }

    /* Snow accumulation on the ground + lock top */
    const MAX_PILE_HEIGHT = 140;
    const MAX_TOP_HEIGHT = 50;
    const TOP_SCALE = 0.36;
    let currentPileHeight = 0;
    let accumulationActive = true;
    const ratePxPerSecond = 8;
    let lastAccumTs = null;

    function accumulateStep(ts) {
      if (!accumulationActive) {
        lastAccumTs = ts;
        requestAnimationFrame(accumulateStep);
        return;
      }
      if (!lastAccumTs) lastAccumTs = ts;
      const dt = Math.min(100, ts - lastAccumTs);
      lastAccumTs = ts;

      const delta = (ratePxPerSecond * dt) / 1000;
      currentPileHeight = Math.min(MAX_PILE_HEIGHT, currentPileHeight + delta);

      snowPileEl.style.height = Math.round(currentPileHeight) + "px";

      // Keep the padlock top pile hidden until there's significant accumulation
      if (snowPileTopEl) {
        // ensure the top pile is fully hidden while height is small (prevents initial cover on phones)
        if (currentPileHeight < MAX_PILE_HEIGHT * 0.6) {
          snowPileTopEl.style.height = "0px";
          snowPileTopEl.classList.remove("show");
        } else {
          // show top pile progressively once the ground pile is reasonably high
          const tHeight = Math.round(Math.min(MAX_TOP_HEIGHT, (currentPileHeight - (MAX_PILE_HEIGHT * 0.6)) / (MAX_PILE_HEIGHT * 0.4) * MAX_TOP_HEIGHT));
          snowPileTopEl.style.height = tHeight + "px";
          if (tHeight > 0) snowPileTopEl.classList.add("show");
        }
      }

      const sheen = snowPileEl.querySelector(".snow-pile-sheen");
      if (sheen) sheen.style.opacity = 0.25 + (currentPileHeight / MAX_PILE_HEIGHT) * 0.75;

      requestAnimationFrame(accumulateStep);
    }

    function startSnowAccumulation() {
      currentPileHeight = 0;
      lastAccumTs = null;
      accumulationActive = true;
      // ensure the top pile is hidden at start so phones don't show it immediately
      if (snowPileTopEl) {
        snowPileTopEl.style.height = "0px";
        snowPileTopEl.classList.remove("show");
      }
      requestAnimationFrame(accumulateStep);
    }

    /* Tilt logic – now only moves falling layers, not the ground pile
       Improved detection and fallbacks so tilt works on more devices.
       Fixes: better event registration on iOS, retries both deviceorientation and devicemotion,
       shows a small toast when orientation events begin, and disables button with a helpful label if unavailable.
    */
    const reduceMotion =
      window.matchMedia &&
      window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    let smoothedBeta = 0, smoothedGamma = 0;
    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function setupTiltSnow() {
      if (!tiltButton) return;

      // improved feature detection: some browsers expose ondeviceorientation, some expose DeviceOrientationEvent
      const hasOrientation =
        ('DeviceOrientationEvent' in window) ||
        ('ondeviceorientation' in window) ||
        ('ondeviceorientationabsolute' in window);

      if (!hasOrientation || reduceMotion) {
        // hide the button if tilt isn't available or user prefers reduced motion
        tiltButton.style.display = "none";
        return;
      }

      let tiltActive = false;
      const isIOSWithPermission = typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function";

      // detect if addEventListener supports options (passive)
      let opts = false;
      try {
        let supported = false;
        const testOpts = Object.defineProperty({}, 'passive', { get() { supported = true; } });
        window.addEventListener('test', null, testOpts);
        window.removeEventListener('test', null, testOpts);
        opts = supported ? { passive: true } : false;
      } catch (err) {
        opts = false;
      }

      let gotOrientation = false;
      let failTimer = null;

      function showSmallToast(text) {
        const t = document.createElement('div');
        t.textContent = text;
        Object.assign(t.style, {
          position: 'fixed',
          left: '50%',
          transform: 'translateX(-50%)',
          bottom: '22%',
          background: 'rgba(0,0,0,0.86)',
          color: '#fff',
          padding: '8px 12px',
          borderRadius: '10px',
          zIndex: 99999,
          fontSize: '14px',
          boxShadow: '0 8px 24px rgba(0,0,0,0.45)',
          transition: 'opacity .35s ease, transform .25s ease',
          opacity: '1',
        });
        document.body.appendChild(t);
        setTimeout(() => {
          t.style.opacity = '0';
          t.style.transform = 'translateX(-50%) translateY(6px)';
          setTimeout(() => { if (t && t.parentNode) t.parentNode.removeChild(t); }, 350);
        }, 1100);
      }

      function onDeviceOrientation(event) {
        if (!tiltActive) return;

        const gamma = typeof event.gamma === "number" ? event.gamma : null;
        const beta = typeof event.beta === "number" ? event.beta : null;

        if (gamma !== null || beta !== null) {
          if (!gotOrientation) {
            gotOrientation = true;
            showSmallToast('Tilt active');
            if (failTimer) { clearTimeout(failTimer); failTimer = null; }
          }
        }

        // fallback to 0 when not numeric so we can continue to render
        const g = gamma === null ? 0 : gamma;
        const b = beta === null ? 0 : beta;

        const targetGamma = clamp(g, -30, 30);
        const targetBeta = clamp(b, -30, 30);

        smoothedGamma += (targetGamma - smoothedGamma) * 0.12;
        smoothedBeta += (targetBeta - smoothedBeta) * 0.12;

        const xNorm = smoothedGamma / 30;
        const yNorm = smoothedBeta / 30;

        if (snowBack) snowBack.style.backgroundPosition = `${xNorm * 8}px ${yNorm * 4}px`;
        if (snowMid) snowMid.style.backgroundPosition = `${xNorm * 14}px ${yNorm * 6}px`;
        if (snowFront) snowFront.style.backgroundPosition = `${xNorm * 20}px ${yNorm * 8}px`;
      }

      function onDeviceMotionFallback(ev) {
        if (!tiltActive) return;
        const ag = ev.accelerationIncludingGravity || ev.acceleration || { x:0, y:0, z:0 };
        const gx = ag.x || 0;
        const gy = ag.y || 0;

        // estimate gamma/beta from gravity vector (approx)
        const estimatedGamma = clamp(-gx * 20, -30, 30);
        const estimatedBeta = clamp(gy * 20, -30, 30);

        if (!gotOrientation) {
          gotOrientation = true;
          showSmallToast('Tilt active');
          if (failTimer) { clearTimeout(failTimer); failTimer = null; }
        }

        smoothedGamma += (estimatedGamma - smoothedGamma) * 0.12;
        smoothedBeta += (estimatedBeta - smoothedBeta) * 0.12;

        const xNorm = smoothedGamma / 30;
        const yNorm = smoothedBeta / 30;

        if (snowBack) snowBack.style.backgroundPosition = `${xNorm * 8}px ${yNorm * 4}px`;
        if (snowMid) snowMid.style.backgroundPosition = `${xNorm * 14}px ${yNorm * 6}px`;
        if (snowFront) snowFront.style.backgroundPosition = `${xNorm * 20}px ${yNorm * 8}px`;
      }

      // helper to (safely) add listeners with our opts fallback
      function addOrientationListeners() {
        try {
          window.addEventListener('deviceorientation', onDeviceOrientation, opts);
        } catch (e) {
          window.addEventListener('deviceorientation', onDeviceOrientation, false);
        }
        try {
          window.addEventListener('deviceorientationabsolute', onDeviceOrientation, opts);
        } catch (e) {
          window.addEventListener('deviceorientationabsolute', onDeviceOrientation, false);
        }
        try {
          window.addEventListener('devicemotion', onDeviceMotionFallback, opts);
        } catch (e) {
          window.addEventListener('devicemotion', onDeviceMotionFallback, false);
        }
      }

      function removeOrientationListeners() {
        try {
          window.removeEventListener('deviceorientation', onDeviceOrientation, opts);
        } catch (e) {
          window.removeEventListener('deviceorientation', onDeviceOrientation, false);
        }
        try {
          window.removeEventListener('deviceorientationabsolute', onDeviceOrientation, opts);
        } catch (e) {
          window.removeEventListener('deviceorientationabsolute', onDeviceOrientation, false);
        }
        try {
          window.removeEventListener('devicemotion', onDeviceMotionFallback, opts);
        } catch (e) {
          window.removeEventListener('devicemotion', onDeviceMotionFallback, false);
        }
      }

      async function enableTilt() {
        // On iOS 13+ permission is required; request it. On Android/others, just enable.
        if (isIOSWithPermission) {
          // Add listeners before/after permission to maximize chances of receiving events
          addOrientationListeners();
          try {
            const state = await DeviceOrientationEvent.requestPermission();
            if (state !== "granted") {
              tiltButton.textContent = "Tilt permission denied";
              tiltButton.disabled = true;
              removeOrientationListeners();
              return;
            }
          } catch (err) {
            // If requestPermission throws, assume not available
            tiltButton.textContent = "Tilt not available";
            tiltButton.disabled = true;
            removeOrientationListeners();
            return;
          }
        } else {
          // Non-iOS: just add listeners
          addOrientationListeners();
        }

        // Now mark active and wait briefly to confirm events come through
        tiltActive = true;
        tiltButton.classList.add("active");
        tiltButton.textContent = "Tilt snow enabled";

        // if we don't receive any orientation-ish events within a second, mark as unavailable
        gotOrientation = false;
        if (failTimer) clearTimeout(failTimer);
        failTimer = setTimeout(() => {
          if (!gotOrientation) {
            // nothing arrived — disable and inform user
            tiltButton.textContent = "Tilt not available";
            tiltButton.disabled = true;
            tiltActive = false;
            removeOrientationListeners();
            smoothedBeta = smoothedGamma = 0;
            if (snowBack) snowBack.style.backgroundPosition = "";
            if (snowMid) snowMid.style.backgroundPosition = "";
            if (snowFront) snowFront.style.backgroundPosition = "";
          }
          failTimer = null;
        }, 1200);
      }

      tiltButton.addEventListener("click", () => {
        if (!tiltActive) {
          enableTilt();
        } else {
          tiltActive = false;
          tiltButton.classList.remove("active");
          tiltButton.textContent = "Enable tilt snow";
          smoothedBeta = smoothedGamma = 0;
          if (snowBack) snowBack.style.backgroundPosition = "";
          if (snowMid) snowMid.style.backgroundPosition = "";
          if (snowFront) snowFront.style.backgroundPosition = "";
          removeOrientationListeners();
          if (failTimer) { clearTimeout(failTimer); failTimer = null; }
        }
      });
    }

    /* Santa flight controller */
    (function setupSanta() {
      if (!santaEl) return;
      if (reduceMotion) { santaEl.style.display = 'none'; return; }

      const MIN_DELAY = 400;
      const MAX_DELAY = 10000;
      let isFlying = false;
      let nextTimer = null;

      function scheduleNext(immediate=false) {
        const delay = immediate ? (200 + Math.random()*800) : (MIN_DELAY + Math.random() * (MAX_DELAY - MIN_DELAY));
        nextTimer = setTimeout(launchSanta, Math.round(delay));
      }

      function launchSanta() {
        if (isFlying) return;
        isFlying = true;

        const tops = ['6%','9%','12%','15%','10%'];
        santaEl.style.top = tops[Math.floor(Math.random()*tops.length)];

        const scales = [0.82,0.9,0.95,1,0.88];
        santaEl.style.transform = `scale(${scales[Math.floor(Math.random()*scales.length)]})`;

        const dir = Math.random() < 0.5 ? 'ltr' : 'rtl';
        santaEl.classList.add('fly-running');

        const duration = 4 + Math.random() * 5;
        santaEl.style.transitionDuration = `${duration}s, 0.6s, 0.2s`;

        if (dir === 'ltr') {
          santaEl.style.left = '-40%';
          void santaEl.offsetWidth;
          santaEl.style.opacity = '1';
          requestAnimationFrame(() => { santaEl.style.left = '120%'; });
        } else {
          santaEl.style.left = '120%';
          void santaEl.offsetWidth;
          santaEl.style.opacity = '1';
          requestAnimationFrame(() => { santaEl.style.left = '-40%'; });
        }

        function onFinish(ev) {
          if (ev.propertyName !== 'left') return;
          santaEl.removeEventListener('transitionend', onFinish);
          santaEl.style.opacity = '0';
          setTimeout(() => { isFlying = false; scheduleNext(); }, 400 + Math.random() * 600);
        }

        santaEl.addEventListener('transitionend', onFinish);
      }

      scheduleNext(true);
      window.addEventListener('pagehide', () => { if (nextTimer) clearTimeout(nextTimer); });
    })();

    startSnowAccumulation();
    setupDials();
    setupTiltSnow();

    /* Small easter egg: triple-tap the shackle to show "Oi, don't cheat" */
    (function setupShackleEasterEgg() {
      const shackleEl = document.querySelector('.shackle');
      if (!shackleEl) return;

      let tapCount = 0;
      let tapTimer = null;
      const TAP_WINDOW = 600; // ms

      function showCheatToast() {
        // create a temporary toast so we don't interfere with the unlock message
        const toast = document.createElement('div');
        toast.textContent = "Oi, don't cheat";
        Object.assign(toast.style, {
          position: 'fixed',
          left: '50%',
          transform: 'translateX(-50%)',
          bottom: '22%',
          background: 'rgba(0,0,0,0.86)',
          color: '#fff',
          padding: '10px 14px',
          borderRadius: '10px',
          zIndex: 99999,
          fontSize: '15px',
          boxShadow: '0 8px 24px rgba(0,0,0,0.45)',
          transition: 'opacity .35s ease, transform .25s ease',
          opacity: '1',
        });
        document.body.appendChild(toast);

        // auto-hide
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(-50%) translateY(6px)';
          setTimeout(() => { if (toast && toast.parentNode) toast.parentNode.removeChild(toast); }, 350);
        }, 1400);
      }

      shackleEl.addEventListener('pointerdown', (e) => {
        tapCount++;
        if (tapTimer) clearTimeout(tapTimer);
        tapTimer = setTimeout(() => { tapCount = 0; tapTimer = null; }, TAP_WINDOW);

        if (tapCount === 3) {
          tapCount = 0;
          if (tapTimer) { clearTimeout(tapTimer); tapTimer = null; }
          showCheatToast();
        }
      });
    })();
  </script>
</body>
</html>
