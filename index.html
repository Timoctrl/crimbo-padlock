<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ellie’s Christmas Escape Padlock</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html,body { margin:0; padding:0; height:100%; overflow:hidden; }

    body {
      min-height:100dvh;
      background: radial-gradient(circle at top, #081326 0, #030713 55%, #000 100%);
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:#fff;
      position:relative;
      display:flex;
      justify-content:center;
      align-items:center;
      padding: env(safe-area-inset-top,12px) 0 env(safe-area-inset-bottom,12px);
    }

    /* SNOW LAYERS */
    .snow-layer {
      position:fixed;
      inset:0;
      pointer-events:none;
      background-repeat:repeat;
      z-index:1;
      mix-blend-mode:screen;
    }

    .snow-back {
      background-size:360px 360px;
      animation:snowSlow 40s linear infinite;
      z-index:1;
      filter:blur(0.3px) contrast(1.05);
      opacity:0.95;
      background-image:
        radial-gradient(6px 6px at 30px 40px, rgba(230,240,255,0.45), transparent 40%),
        radial-gradient(5px 5px at 170px 80px, rgba(255,230,245,0.5), transparent 40%),
        radial-gradient(4px 4px at 260px 30px, rgba(210,240,255,0.4), transparent 40%),
        radial-gradient(6px 6px at 220px 170px, rgba(255,255,255,0.44), transparent 40%),
        radial-gradient(5px 5px at 60px 260px, rgba(220,255,230,0.42), transparent 40%),
        radial-gradient(8px 8px at 300px 300px, rgba(255,255,255,0.32), transparent 40%);
    }
    @keyframes snowSlow { 0%{transform:translateY(-90px)}100%{transform:translateY(90px)} }

    .snow-mid {
      background-size:260px 260px;
      animation:snowMid 22s linear infinite;
      z-index:2;
      filter:blur(0.45px) contrast(1.08);
      opacity:0.98;
      background-image:
        radial-gradient(8px 8px at 20px 20px, rgba(230,244,255,0.78), transparent 40%),
        radial-gradient(7px 7px at 140px 50px, rgba(255,235,245,0.7), transparent 40%),
        radial-gradient(6px 6px at 70px 200px, rgba(235,255,240,0.7), transparent 40%),
        radial-gradient(8px 8px at 240px 10px, rgba(250,252,255,0.8), transparent 40%),
        radial-gradient(5px 5px at 180px 240px, rgba(230,250,255,0.7), transparent 40%);
    }
    @keyframes snowMid { 0%{transform:translate(-12px,-100px)}100%{transform:translate(12px,100px)} }

    .snow-front {
      background-size:140px 140px;
      animation:snowFast 14s linear infinite;
      z-index:9;
      filter:blur(0.7px) contrast(1.12) saturate(1.05);
      opacity:1;
      background-image:
        radial-gradient(10px 10px at 20px 20px, rgba(255,255,255,0.98), transparent 45%),
        radial-gradient(8px 8px at 100px 40px, rgba(210,235,255,0.97), transparent 45%),
        radial-gradient(10px 10px at 220px 120px, rgba(255,235,245,0.98), transparent 45%),
        radial-gradient(8px 8px at 60px 200px, rgba(220,255,235,0.97), transparent 45%),
        radial-gradient(10px 10px at 260px 10px, rgba(255,255,255,0.98), transparent 45%),
        radial-gradient(8px 8px at 150px 260px, rgba(215,240,255,0.96), transparent 45%),
        radial-gradient(14px 14px at 50px 120px, rgba(255,230,210,0.9), transparent 45%),
        radial-gradient(12px 12px at 180px 40px, rgba(230,255,230,0.9), transparent 45%);
    }
    @keyframes snowFast { 0%{transform:translate(28px,-120px)}100%{transform:translate(-28px,120px)} }

    /* SANTA (background) */
    .santa {
      position: fixed;
      top: 10%;
      left: -40%;
      width: 260px;
      height: auto;
      z-index: 0; /* behind snow layers */
      pointer-events: none;
      opacity: 0;
      transform-origin: center;
      will-change: left, transform, top, opacity;
    }
    .santa.fly-running { transition-property: left, opacity, transform; transition-timing-function: linear, linear, ease; }

    /* BOTTOM PILE (GROUND – stays horizontal) */
    .snow-pile {
      position: fixed;
      bottom:0;
      left:0;
      right:0;
      height:0;
      max-height:220px;
      z-index:3;
      pointer-events:none;
      display:flex;
      justify-content:center;
      overflow:visible;
      transition:height 420ms ease-out;
    }
    .snow-pile-inner {
      position:absolute; left:0; right:0; bottom:0; height:100%;
      background:
        radial-gradient(ellipse at bottom, rgba(255,255,255,0.98) 0%, rgba(255,255,255,0.9) 30%, rgba(230,244,255,0.2) 65%, transparent 100%),
        radial-gradient(circle at 12% 10%, rgba(255,232,210,0.9), transparent 60%),
        radial-gradient(circle at 88% 12%, rgba(214,237,255,0.88), transparent 60%);
      filter: blur(0.6px) contrast(1.05);
      box-shadow: inset 0 8px 28px rgba(255,255,255,0.08), 0 -2px 10px rgba(0,0,0,0.35);
      border-top-left-radius:60% 40%;
      border-top-right-radius:60% 40%;
      pointer-events:none;
      width:100%;
      transform-origin:50% 100%;
    }
    .snow-pile-sheen {
      position:absolute;
      left:10%;
      right:10%;
      bottom:calc(100% - 10px);
      height:24px;
      background:linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.12));
      filter:blur(8px);
      opacity:0.6;
      border-radius:50%;
      pointer-events:none;
      transform-origin:50% 100%;
    }

    /* TOP PILE OVER LOCK */
    .snow-pile-top {
      position:absolute;
      left:-12px;
      width:calc(100% + 24px);
      top:-18px;
      height:0;
      z-index:5;
      pointer-events:none;
      overflow:visible;
      transition:height 420ms ease-out;
    }
    .snow-pile-top svg { width:100%; height:100%; display:block; overflow:visible; }
    .snow-pile-top-inner { pointer-events:none; }

    /* PADLOCK & UI */
    .app-shell { position:relative; width:100%; max-width:420px; margin:0 auto; padding:0 16px 24px; z-index:6; }
    .padlock { position:relative; margin:0 auto; max-width:300px; padding-top:50px; animation:fadeIn .7s ease-out both; z-index:6; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(30px) scale(.9)} to{opacity:1; transform:translateY(0) scale(1)} }
    .padlock.open { transform:translateY(-4px) scale(1.02); }

    .shackle {
      position:absolute;
      top:-70px;
      left:50%;
      width:140px;
      height:120px;
      border-radius:80px 80px 0 0;
      border:10px solid #d6dde2;
      border-bottom:none;
      background:transparent;
      transform:translateX(-50%);
      z-index:7;
      box-shadow:0 8px 14px rgba(0,0,0,0.45);
      transition:transform .6s ease;
      transform-origin:20% 20%;
    }
    .shackle::before {
      content:"";
      position:absolute;
      top:16px;
      left:50%;
      width:104px;
      height:92px;
      border-radius:60px 60px 0 0;
      transform:translateX(-50%);
      background: radial-gradient(circle at 50% 0, #0b1527 0, #030713 55%, #000 100%);
      box-shadow: inset 0 4px 6px rgba(0,0,0,0.45);
    }
    .shackle::after {
      content:"";
      position:absolute;
      bottom:-4px;
      left:50%;
      width:40px;
      height:22px;
      transform:translateX(-50%);
      background:linear-gradient(180deg,#f9de9c,#c18a2d 70%,#8e5d13 100%);
      border-radius:0 0 12px 12px;
      box-shadow:0 2px 4px rgba(0,0,0,0.6), inset 0 0 4px rgba(255,255,255,0.5);
    }

    .padlock.open .shackle { transform:translate(-10px,-10px) rotate(-25deg); }

    .lock-body {
      background: linear-gradient(180deg,#fbeab7,#d6a850 60%,#a36b1e 100%);
      padding:18px 14px 22px;
      border-radius:20px;
      box-shadow:
        0 16px 28px rgba(0,0,0,0.85),
        0 0 20px rgba(255,210,130,0.5),
        inset 0 0 16px rgba(0,0,0,0.4);
      border:1px solid rgba(255,245,220,0.9);
      position:relative;
      z-index:4;
      overflow:visible;
    }

    /* FAIRY LIGHTS */
    .fairy-lights {
      position:absolute;
      top:8px;
      left:16px;
      right:16px;
      height:18px;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 5% 60%, rgba(255,180,130,1), transparent 60%),
        radial-gradient(circle at 20% 40%, rgba(255,90,120,0.95), transparent 60%),
        radial-gradient(circle at 40% 55%, rgba(120,220,255,0.95), transparent 60%),
        radial-gradient(circle at 60% 45%, rgba(140,255,190,0.95), transparent 60%),
        radial-gradient(circle at 80% 60%, rgba(255,220,130,0.98), transparent 60%),
        radial-gradient(circle at 95% 40%, rgba(200,190,255,0.98), transparent 60%);
      filter:blur(0.4px);
      mix-blend-mode:screen;
      opacity:0.9;
      animation:twinkle 2.8s ease-in-out infinite alternate;
    }
    @keyframes twinkle {
      0% { opacity:0.4; transform:translateY(0); }
      50%{ opacity:0.9; transform:translateY(-0.5px); }
      100%{ opacity:0.6; transform:translateY(0); }
    }

    .title { text-align:center; font-size:15px; letter-spacing:0.22em; text-transform:uppercase; color:#351f0a; margin-bottom:3px; }
    .subtitle { text-align:center; font-size:12px; letter-spacing:0.25em; text-transform:uppercase; color:#5a310f; margin-bottom:14px; }
    .dial-plate {
      background: radial-gradient(circle at top,#28422c,#111b13 60%,#050806 100%);
      padding:14px 10px 16px;
      border-radius:14px;
      box-shadow:inset 0 0 18px rgba(0,0,0,0.9), 0 0 8px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.12);
    }
    .dials { display:flex; justify-content:center; gap:8px; margin-bottom:12px; flex-wrap:nowrap; }
    .dial {
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:6px 5px;
      width:46px;
      background:linear-gradient(180deg,#232323,#050505);
      border-radius:10px;
      box-shadow:inset 0 0 8px rgba(0,0,0,0.9), 0 4px 7px rgba(0,0,0,0.7);
      border:1px solid rgba(255,255,255,0.06);
      cursor:grab;
    }
    .dial.dragging { cursor:grabbing; }
    .dial button {
      border:none;
      background:linear-gradient(180deg,#33b46b,#13763f);
      color:#f6fff6;
      border-radius:6px;
      padding:6px 0;
      width:100%;
      font-size:18px;
      box-shadow:0 2px 3px rgba(0,0,0,0.7);
      min-height:34px;
    }
    .display {
      margin:6px 0;
      padding:7px 0;
      width:100%;
      text-align:center;
      background:#000;
      color:#00f7ff;
      font-size:26px;
      border-radius:6px;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.9);
      touch-action:none;
    }
    .hint { text-align:center; font-size:12px; color:#ffe9c0; opacity:0.9; margin-top:4px; }

    .tilt-btn {
      margin:10px auto 0;
      padding:6px 12px;
      font-size:12px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.45);
      color:#fff;
      cursor:pointer;
      display:block;
    }
    .tilt-btn.active { background: rgba(12,103,34,0.8); border-color: rgba(180,255,200,0.8); }

    .message {
      text-align:center;
      margin-top:12px;
      font-size:15px;
      line-height:1.4;
      opacity:0;
      color:#fff;
      background: rgba(0,0,0,0.78);
      border-radius:10px;
      padding:8px 10px;
      text-shadow:0 0 6px rgba(0,0,0,0.8);
      border:1px solid rgba(255,255,255,0.12);
      transform:translateY(8px);
      transition:opacity .4s ease, transform .4s ease;
    }
    .message span { display:block; font-size:13px; margin-top:3px; color:#e6ffe3; }
    .padlock.open .message { opacity:1; transform:translateY(0); }

    .keyhole {
      margin:12px auto 0;
      width:18px;
      height:26px;
      border-radius:12px;
      background: radial-gradient(circle at 50% 20%, #222,#000);
      box-shadow: inset 0 0 4px rgba(255,255,255,0.1);
    }

    /* reduced-motion */
    @media (prefers-reduced-motion: reduce) {
      .snow-layer, .snow-pile, .padlock, .santa { animation:none !important; }
      .snow-back, .snow-mid, .snow-front { background-position:center !important; }
      .snow-pile-inner, .snow-pile-top-inner { transition:none !important; }
      .santa { display:none; }
    }

    @media (max-width:400px) {
      .padlock { max-width:260px; padding-top:45px; }
      .dial { width:40px; }
      .title { font-size:13px; letter-spacing:0.18em; }
      .subtitle { font-size:11px; letter-spacing:0.2em; }
      .message { font-size:14px; }
      .santa { width:180px; left:-40%; top:8%; }
    }
  </style>
</head>
<body>
  <!-- SANTA -->
  <div class="santa" id="santa" aria-hidden="true">
    <svg viewBox="0 0 300 90" width="100%" height="100%" preserveAspectRatio="xMinYMid meet" aria-hidden="true">
      <g stroke="none" transform="translate(0,6)">
        <!-- Sleigh body -->
        <path d="M10 50 Q40 70 90 70 L200 70 Q230 70 250 58 L240 56 Q225 66 200 66 L110 66 Q60 66 10 50 Z"
              fill="#f8d79b"/>
        <!-- Seat -->
        <rect x="120" y="26" width="36" height="18" rx="4" fill="#c0383e"/>
        <!-- Driver head -->
        <circle cx="126" cy="22" r="6" fill="#ffe6c9"/>
        <!-- Hat -->
        <rect x="122" y="16" width="8" height="6" rx="2" fill="#d7263d"/>
        <circle cx="130" cy="16" r="2" fill="#ffffff"/>
        <!-- Runners -->
        <path d="M20 74 L68 74" stroke="#f2f2f2" stroke-width="4" stroke-linecap="round" />
        <path d="M108 74 L198 74" stroke="#f2f2f2" stroke-width="4" stroke-linecap="round" />
        <!-- Rope -->
        <path d="M250 50 Q270 48 284 40" stroke="#f7e0a3" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" />
        <!-- Reindeer 1 -->
        <g transform="translate(264,16) scale(1)">
          <path d="M0 10 L6 6 L12 10 L10 14 L14 16 L9 18 L7 22 L2 20 Z" fill="#f4d3a1"/>
          <path d="M-18 6 L-12 0 L-8 2 L-6 6 L-2 4 L-4 8 L-10 10 Z" fill="#f4d3a1"/>
          <circle cx="13" cy="11" r="1.6" fill="#ff4d4d"/>
        </g>
        <!-- Reindeer 2 -->
        <g transform="translate(285,8) scale(.92)">
          <path d="M0 10 L6 6 L12 10 L10 14 L14 16 L9 18 L7 22 L2 20 Z" fill="#f4d3a1"/>
          <path d="M-18 6 L-12 0 L-8 2 L-6 6 L-2 4 L-4 8 L-10 10 Z" fill="#f4d3a1"/>
          <circle cx="13" cy="11" r="1.6" fill="#ff4d4d"/>
        </g>
        <!-- Reindeer 3 -->
        <g transform="translate(305,20) scale(.86)">
          <path d="M0 10 L6 6 L12 10 L10 14 L14 16 L9 18 L7 22 L2 20 Z" fill="#f4d3a1"/>
          <path d="M-18 6 L-12 0 L-8 2 L-6 6 L-2 4 L-4 8 L-10 10 Z" fill="#f4d3a1"/>
          <circle cx="13" cy="11" r="1.6" fill="#ff4d4d"/>
        </g>
        <!-- sparkle -->
        <circle cx="170" cy="42" r="2.2" fill="#ffffff"/>
      </g>
    </svg>
  </div>

  <!-- SNOW LAYERS -->
  <div class="snow-layer snow-back"></div>
  <div class="snow-layer snow-mid"></div>
  <div class="snow-layer snow-front"></div>

  <!-- BOTTOM PILE -->
  <div class="snow-pile" id="snowPile">
    <div class="snow-pile-inner" id="snowPileInner"></div>
    <div class="snow-pile-sheen" aria-hidden="true"></div>
  </div>

  <audio id="unlockSound" src="unlock.mp3"></audio>

  <div class="app-shell">
    <div class="padlock" id="padlock">
      <div class="shackle"></div>

      <div class="lock-body">
        <div class="fairy-lights" aria-hidden="true"></div>

        <!-- TOP PILE over lock -->
        <div class="snow-pile-top" id="snowPileTop" aria-hidden="true">
          <svg viewBox="0 0 300 80" preserveAspectRatio="none" aria-hidden="true">
            <defs>
              <filter id="blurEdge" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="3"></feGaussianBlur>
              </filter>

              <clipPath id="lockClipPath">
                <rect x="0" y="0" width="300" height="80" rx="18" ry="18"></rect>
              </clipPath>

              <mask id="lockMaskSvg" maskUnits="userSpaceOnUse" maskContentUnits="userSpaceOnUse">
                <rect x="0" y="0" width="300" height="80" rx="18" ry="18" fill="white" filter="url(#blurEdge)"></rect>
                <ellipse cx="150" cy="18" rx="80" ry="10" fill="white" fill-opacity="0.96"></ellipse>
              </mask>
            </defs>

            <g clip-path="url(#lockClipPath)">
              <rect x="0" y="0" width="300" height="80" fill="none" />
              <g mask="url(#lockMaskSvg)">
                <rect x="0" y="0" width="300" height="80" fill="none" />
                <ellipse cx="150" cy="34" rx="150" ry="60" fill="#ffffff" fill-opacity="0.95" />
                <ellipse cx="60" cy="30" rx="48" ry="28" fill="#f4f7ff" fill-opacity="0.96" />
                <ellipse cx="200" cy="28" rx="56" ry="24" fill="#fff1e3" fill-opacity="0.95" />
                <ellipse cx="150" cy="18" rx="100" ry="12" fill="#ffffff" fill-opacity="0.9" />
                <g fill-opacity="0.16">
                  <circle cx="40" cy="26" r="2.2" fill="#d6ecff"></circle>
                  <circle cx="80" cy="34" r="1.8" fill="#ffe0f1"></circle>
                  <circle cx="120" cy="28" r="1.6" fill="#e0ffe8"></circle>
                  <circle cx="170" cy="30" r="2.6" fill="#ffffff"></circle>
                  <circle cx="220" cy="26" r="1.6" fill="#e3f2ff"></circle>
                </g>
              </g>

              <rect x="0" y="54" width="300" height="26" fill="rgba(0,0,0,0.18)" opacity="0.5" />
            </g>
          </svg>
        </div>

        <div class="title">ELLIE’S ESCAPE</div>
        <div class="subtitle">CHRISTMAS EDITION</div>

        <div class="dial-plate">
          <div class="dials" id="dials"></div>

          <div class="hint">
            Ellie, drag or tap the dials to find the secret 6-letter word.<br>
            <span>When you crack it, your Christmas surprise will unlock…</span>
          </div>

          <button class="tilt-btn" id="tiltButton" type="button">Enable tilt snow</button>

          <div class="message" id="message"></div>
          <div class="keyhole"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CODE = "GLOVES";
    const SUCCESS_MESSAGE_MAIN = "Unlocked, Ellie! Merry Christmas!";
    const SUCCESS_MESSAGE_SUB = "You found the key – check inside the gloves.";

    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const dialsContainer = document.getElementById("dials");
    const padlockEl = document.getElementById("padlock");
    const messageEl = document.getElementById("message");
    const unlockSound = document.getElementById("unlockSound");

    const snowBack = document.querySelector(".snow-back");
    const snowMid = document.querySelector(".snow-mid");
    const snowFront = document.querySelector(".snow-front");
    const tiltButton = document.getElementById("tiltButton");
    const santaEl = document.getElementById("santa");

    const snowPileEl = document.getElementById("snowPile");
    const snowPileInner = document.getElementById("snowPileInner");
    const snowPileTopEl = document.getElementById("snowPileTop");

    const dialControllers = [];
    let globalDragging = false;

    document.addEventListener("touchmove", (e) => {
      if (globalDragging) e.preventDefault();
    }, { passive: false });

    function createDial(initialLetter = "A") {
      const dial = document.createElement("div");
      dial.className = "dial";

      const upBtn = document.createElement("button");
      upBtn.textContent = "▲";

      const display = document.createElement("div");
      display.className = "display";
      display.textContent = initialLetter;

      const downBtn = document.createElement("button");
      downBtn.textContent = "▼";

      dial.appendChild(upBtn);
      dial.appendChild(display);
      dial.appendChild(downBtn);

      let index = letters.indexOf(initialLetter);
      if (index === -1) index = 0;

      function updateDisplay() {
        display.textContent = letters[index];
        checkCode();
      }

      upBtn.onclick = () => {
        index = (index + 1) % letters.length;
        updateDisplay();
      };
      downBtn.onclick = () => {
        index = (index - 1 + letters.length) % letters.length;
        updateDisplay();
      };

      const STEP = 26;
      let dragging = false, lastY = 0, accum = 0;

      function start(y) {
        dragging = true;
        globalDragging = true;
        lastY = y;
        accum = 0;
        dial.classList.add("dragging");
      }

      function move(y) {
        const dy = y - lastY;
        accum += dy;
        lastY = y;

        while (accum <= -STEP) {
          index = (index + 1) % letters.length;
          accum += STEP;
          updateDisplay();
        }
        while (accum >= STEP) {
          index = (index - 1 + letters.length) % letters.length;
          accum -= STEP;
          updateDisplay();
        }
      }

      function end() {
        dragging = false;
        globalDragging = false;
        dial.classList.remove("dragging");
      }

      display.addEventListener("pointerdown", (e) => {
        display.setPointerCapture(e.pointerId);
        start(e.clientY);
      });
      display.addEventListener("pointermove", (e) => {
        if (dragging) move(e.clientY);
      });
      display.addEventListener("pointerup", end);
      display.addEventListener("pointercancel", end);

      return { element: dial, getLetter: () => letters[index] };
    }

    function setupDials() {
      for (let i = 0; i < CODE.length; i++) {
        const c = createDial("A");
        dialControllers.push(c);
        dialsContainer.appendChild(c.element);
      }
    }

    function checkCode() {
      const attempt = dialControllers.map((c) => c.getLetter()).join("");
      if (attempt === CODE && !padlockEl.classList.contains("open")) {
        padlockEl.classList.add("open");
        messageEl.innerHTML = SUCCESS_MESSAGE_MAIN + "<br><span>" + SUCCESS_MESSAGE_SUB + "</span>";
        unlockSound.currentTime = 0;
        unlockSound.play().catch(() => {});
      }
    }

    /* Snow accumulation on the ground + lock top */
    const MAX_PILE_HEIGHT = 140;
    const MAX_TOP_HEIGHT = 50;
    const TOP_SCALE = 0.36;
    let currentPileHeight = 0;
    let accumulationActive = true;
    const ratePxPerSecond = 8;
    let lastAccumTs = null;

    function accumulateStep(ts) {
      if (!accumulationActive) {
        lastAccumTs = ts;
        requestAnimationFrame(accumulateStep);
        return;
      }
      if (!lastAccumTs) lastAccumTs = ts;
      const dt = Math.min(100, ts - lastAccumTs);
      lastAccumTs = ts;

      const delta = (ratePxPerSecond * dt) / 1000;
      currentPileHeight = Math.min(MAX_PILE_HEIGHT, currentPileHeight + delta);

      snowPileEl.style.height = Math.round(currentPileHeight) + "px";

      const targetTop = Math.min(MAX_TOP_HEIGHT, currentPileHeight * TOP_SCALE);
      const topHeight = currentPileHeight > 6 ? Math.round(targetTop) : 0;
      snowPileTopEl.style.height = topHeight + "px";

      const sheen = snowPileEl.querySelector(".snow-pile-sheen");
      if (sheen) sheen.style.opacity = 0.25 + (currentPileHeight / MAX_PILE_HEIGHT) * 0.75;

      requestAnimationFrame(accumulateStep);
    }

    function startSnowAccumulation() {
      currentPileHeight = 0;
      lastAccumTs = null;
      accumulationActive = true;
      requestAnimationFrame(accumulateStep);
    }

    /* Tilt logic – now only moves falling layers, not the ground pile */
    const reduceMotion =
      window.matchMedia &&
      window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    let smoothedBeta = 0, smoothedGamma = 0;
    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    function setupTiltSnow() {
      if (!tiltButton) return;
      const hasOrientation = "DeviceOrientationEvent" in window;
      if (!hasOrientation || reduceMotion) { tiltButton.style.display = "none"; return; }

      let tiltActive = false;

      function onDeviceOrientation(event) {
        if (!tiltActive) return;

        const gamma = typeof event.gamma === "number" ? event.gamma : 0;
        const beta = typeof event.beta === "number" ? event.beta : 0;

        const targetGamma = clamp(gamma, -30, 30);
        const targetBeta = clamp(beta, -30, 30);

        smoothedGamma += (targetGamma - smoothedGamma) * 0.12;
        smoothedBeta += (targetBeta - smoothedBeta) * 0.12;

        const xNorm = smoothedGamma / 30;
        const yNorm = smoothedBeta / 30;

        snowBack.style.backgroundPosition = `${xNorm * 8}px ${yNorm * 4}px`;
        snowMid.style.backgroundPosition = `${xNorm * 14}px ${yNorm * 6}px`;
        snowFront.style.backgroundPosition = `${xNorm * 20}px ${yNorm * 8}px`;
        /* ground pile left perfectly horizontal */
      }

      async function enableTilt() {
        if (typeof DeviceOrientationEvent !== "undefined" && typeof DeviceOrientationEvent.requestPermission === "function") {
          try {
            const state = await DeviceOrientationEvent.requestPermission();
            if (state !== "granted") { tiltButton.textContent = "Tilt permission denied"; tiltButton.disabled = true; return; }
          } catch (err) { tiltButton.textContent = "Tilt not available"; tiltButton.disabled = true; return; }
        }
        tiltActive = true;
        tiltButton.classList.add("active");
        tiltButton.textContent = "Tilt snow enabled";
        window.addEventListener("deviceorientation", onDeviceOrientation);
      }

      tiltButton.addEventListener("click", () => {
        if (!tiltActive) {
          enableTilt();
        } else {
          tiltActive = false;
          tiltButton.classList.remove("active");
          tiltButton.textContent = "Enable tilt snow";
          smoothedBeta = smoothedGamma = 0;
          snowBack.style.backgroundPosition = "";
          snowMid.style.backgroundPosition = "";
          snowFront.style.backgroundPosition = "";
        }
      });
    }

    /* Santa flight controller */
    (function setupSanta() {
      if (!santaEl) return;
      if (reduceMotion) { santaEl.style.display = 'none'; return; }

      const MIN_DELAY = 400;
      const MAX_DELAY = 10000;
      let isFlying = false;
      let nextTimer = null;

      function scheduleNext(immediate=false) {
        const delay = immediate ? (200 + Math.random()*800) : (MIN_DELAY + Math.random() * (MAX_DELAY - MIN_DELAY));
        nextTimer = setTimeout(launchSanta, Math.round(delay));
      }

      function launchSanta() {
        if (isFlying) return;
        isFlying = true;

        const tops = ['6%','9%','12%','15%','10%'];
        santaEl.style.top = tops[Math.floor(Math.random()*tops.length)];

        const scales = [0.82,0.9,0.95,1,0.88];
        santaEl.style.transform = `scale(${scales[Math.floor(Math.random()*scales.length)]})`;

        const dir = Math.random() < 0.5 ? 'ltr' : 'rtl';
        santaEl.classList.add('fly-running');

        const duration = 4 + Math.random() * 5;
        santaEl.style.transitionDuration = `${duration}s, 0.6s, 0.2s`;

        if (dir === 'ltr') {
          santaEl.style.left = '-40%';
          void santaEl.offsetWidth;
          santaEl.style.opacity = '1';
          requestAnimationFrame(() => { santaEl.style.left = '120%'; });
        } else {
          santaEl.style.left = '120%';
          void santaEl.offsetWidth;
          santaEl.style.opacity = '1';
          requestAnimationFrame(() => { santaEl.style.left = '-40%'; });
        }

        function onFinish(ev) {
          if (ev.propertyName !== 'left') return;
          santaEl.removeEventListener('transitionend', onFinish);
          santaEl.style.opacity = '0';
          setTimeout(() => { isFlying = false; scheduleNext(); }, 400 + Math.random() * 600);
        }

        santaEl.addEventListener('transitionend', onFinish);
      }

      scheduleNext(true);
      window.addEventListener('pagehide', () => { if (nextTimer) clearTimeout(nextTimer); });
    })();

    startSnowAccumulation();
    setupDials();
    setupTiltSnow();
  </script>
</body>
</html>